# 簡易電卓プログラムの脆弱性対策

実は、ここまでで作った簡易電卓プログラムは、以下の典型的なセキュリティホールを孕んでいます。

* XSS 脆弱性
* CSRF 脆弱性

Web アプリケーションに対する攻撃手法には様々なものがあり、全てに完璧に対策するのはなかなか大変です。

将来的には様々な攻撃手法とその対策方法を学んで実践していってもらいたいと思いますが、ひとまずここでは、特にポピュラーな攻撃手法である XSS と CSRF を取り上げて解説したいと思います。

くれぐれも、この 2 つを理解しただけで「セキュリティ対策はもうバッチリ！」などと思わないように気をつけてください。

なお、Web アプリケーションのセキュリティ対策について学ぶ場合、徳丸浩先生の [体系的に学ぶ 安全なWebアプリケーションの作り方](http://www.amazon.co.jp/gp/product/4797361190/ref=as_li_tf_tl?ie=UTF8&camp=767&creative=3999&creativeASIN=4797361190&link_code=as3&tag=540301102-22) という本（通称：徳丸本）がバイブルです。ぜひ一度読んでみてください。

## XSS（クロス・サイト・スクリプティング）

[XSS](http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0) は、Web ページ内に悪意ある JavaScript コードを埋め込むことで、その Web ページの利用者を攻撃する手法です。

分かりやすい例を用意してみたので、[こちら](http://localhost/php-abc-quests/practices/03/calc/index.php?left=%3C%2Fp%3E%3Cscript%3Ealert%28%27You%5C%27re+attacked+%21%21%27%29%3B+var+x+%3D+1&operator=%2B&right=1%3B%3C%2Fscript%3E%3Cp%3E) をクリックしてみてください。

あなたの作った簡易電卓プログラムのページ上で `You're attacked !!` というアラートが表示されたのではないでしょうか。これが XSS による攻撃です。

### 原理

表示されたアラートは、簡易電卓プログラムのページに埋め込まれた JavaScript コードが実行された結果です。

もちろんあなたはそんな JavaScript コードは書いていません。このコードは攻撃者があなたのページに悪意を持って埋め込んだものなのです。

先ほどクリックして開いたページを見ると、フォームの入力内容は以下のようになっていますね。

* `</p><script>alert('You\'re attacked !!'); var x = 1`
* `+`
* `1;</script><p>`

これが入力されたときに、あなたの PHP プログラム上では何が起こるでしょうか。

```php
$result = "{$left} {$operator} {$right} = {$answer}";
```

まずこの部分では、

```php
$result = "</p><script>alert('You\'re attacked !!'); var x = 1 + 1;</script><p> = 1";
```

という文字列が代入されます。（文字列同士を加算した結果、無意味な `1` という計算結果になっています）

その後、

```php
<p><?php echo $result; ?></p>
```

ここで

```php
<p></p><script>alert('You\'re attacked !!'); var x = 1 + 1;</script><p> = 1</p>
```

このように展開されます。

見やすく整形すると以下のような出力内容です。

```php
<p></p>
<script>                            // JavaScript 開始
    alert('You\'re attacked !!');   // アラートを出力
    var x = 1 + 1;                  // 意味のないコード
</script>                           // JavaScript 終了
<p> = 1</p>
```

この例では「ただアラートを表示するだけ」という特に害のないスクリプトですが、任意のスクリプトが埋め込めるので、

* フォームの送信先を書き換えて、送信内容を盗み見る
* Cookie を盗む

といったことも可能です。

例えばログイン制のサイトに XSS 脆弱性があった場合、そのサイトのユーザが攻撃者に Cookie を盗まれるということは、アカウントを乗っ取られることとイコールです。怖いですね。

### 対策

XSS の対策は基本的には結構簡単です。

要は、ユーザが入力した内容をそのまま HTML に出力するときに、出力した内容が **HTML タグとして評価されないように** しておけばよいのです。

これを **エスケープする** と言います。

HTML には [実体参照](http://ja.wikipedia.org/wiki/%E6%96%87%E5%AD%97%E5%8F%82%E7%85%A7#.E6.96.87.E5.AD.97.E5.AE.9F.E4.BD.93.E5.8F.82.E7.85.A7.EF.BC.88.E5.AE.9F.E4.BD.93.E5.8F.82.E7.85.A7.EF.BC.89) という特殊な文字表現があり、

* `&amp;` は `&`
* `&lt;` は `<`
* `&gt;` は `>`
* `&quot;` は `"`

をそれぞれ表します。これを利用して、`&` `<` `>` `"` といった **危うい** 文字を、あらかじめ `&amp;` `&lt;` `&gt;` `&quot;` といった実体参照に置換（＝エスケープ）した上で出力すればよいのです。

PHP には、この文字列のエスケープ処理を行うための組み込み関数 [htmlspecialchars()](http://php.net/manual/ja/function.htmlspecialchars.php) が用意されています。

ユーザが入力した内容をそのまま出力する場合は、これを使ってエスケープしたものを `echo` するようにすれば OK です。

```php
// XSS 未対策
あなたの名前は <?php echo $name; ?> ですね！

// XSS 対策済
あなたの名前は <?php echo htmlspecialchars($name, ENT_QUOTES); ?> ですね！
```

※ ただし、この方法ですべての XSS 攻撃を防げるわけではありません。ユーザの入力値を URL に使う場合や、CSS の中で使う場合など、いくつかの例外があります。
あくまで基本的な対策として理解しておいてください。

### 実践編

では、実際に簡易電卓プログラムに XSS 対策を施しましょう。

#### ヒント

ユーザの入力内容をそのまま HTML に出力したい場合は、適切にエスケープする

#### 解答例

解答例は [こちら](calc-security-impl-01.md) です。自力でチャレンジしてから見てください。

対策を行ったら、再度 [こちら](http://localhost/php-abc-quests/practices/03/calc/index.php?left=%3C%2Fp%3E%3Cscript%3Ealert%28%27You%5C%27re+attacked+%21%21%27%29%3B+var+x+%3D+1&operator=%2B&right=1%3B%3C%2Fscript%3E%3Cp%3E) にアクセスしてみてください。今度はアラートが表示されず、ただの文字列として `</p><script>alert('You\'re attacked !!'); var x = 1 + 1;</script><p> = 1` が画面に表示されているはずです :+1:

## CSRF（クロス・サイト・リクエスト・フォージェリ）

[CSRF](http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA) は、ユーザに意図しない内容のリクエストを強制的に送信させる攻撃です。リクエスト送信先の Web サイトが CSRF 対策を行っていないと、ユーザの意図しないリクエストが受理され、

* 掲示板に意図しない書き込みをさせられる
* オンラインショップで意図しない買い物をさせられる

などの被害が起こり得ます。

これについても実際の例を用意してみたので、[こちら](http://php-abc-quests.herokuapp.com/03-index.php/csrf-demo/) をクリックしてみてください。

「何もないページ」が表示されただけなのに、あなたのメールアドレス宛てに簡易電卓プログラムからメールが届いたのではないでしょうか。これが CSRF による攻撃です。

> ちなみに、`CSRF` は「シーサーフ」と読まれることが多い（？）です。

### 原理

原理については [Wikipedia の例](http://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA#.E5.8E.9F.E7.90.86) が分かりやすいです。先ほどのデモではこの例と全く同じことをしています。

この例では、ユーザは `clickme.html` という、掲示板とは全く関係のないページを閲覧しただけなのに、気付かないうちに `http://example.com/bbs` の掲示板に意図しない投稿をさせられることになります。

`http://example.com/bbs` が適切に CSRF 対策を行っていれば、このような攻撃は防ぐことができます。

### 対策

CSRF の対策は、理屈自体は単純です。

要は、Web ページ側に、意図しないリクエストを受け付けないためのチェック機構があればよいわけです。

これを実現するための最もオーソドックスな方法は、**ワンタイムトークン** を使って正規のフォームからのリクエストかそうでないかを判別できるようにすることです。

#### ワンタイムトークン

ワンタイムトークンとは、アクセスする度に毎回変わるランダムな文字列のことです。

フォームに `<input type="hidden">` を一つ追加し、この `<input>` からワンタイムトークンを送信するようにします。これをサーバ側でチェックすることで、正規のフォームから送信されたリクエストかどうかを判定します。

ワンタイムトークンはサーバ側でランダムに生成したものなので、攻撃者が推測することはほぼ不可能です。したがって、正しいワンタイムトークンがパラメータとして送られてきたなら、正規のフォームからのリクエストであると信頼できるわけです。

プログラムの流れは以下のようになります。

1. [セッション](http://php.net/manual/ja/session.examples.basic.php) の使用を宣言する
2. ワンタイムトークンをランダムに生成し、セッションに保存する
3. `2` で生成したワンタイムトークンを HTML に出力（フォームの hidden 要素として）
4. POST リクエストで送られてきたワンタイムトークンが、前回生成したもの（今セッションに保存されているもの）と一致しているかをチェック

#### セッション

ここで「セッション」という言葉が初めて出てきました。

[HTTP はステートレスなプロトコル](https://www.google.co.jp/search?q=http+%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%AC%E3%82%B9&oq=http+%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%AC%E3%82%B9&aqs=chrome..69i57.2351j0j4&sourceid=chrome&es_sm=119&ie=UTF-8) なので、通常は **リクエストをまたいで状態を保持することはできない** のですが、Web アプリケーションを作成する上では、それだと困ることも多いです。

そこで、クライアントごとの情報をサーバ側で（一定期間）保持しておくことで、リクエストを跨いでクライアントの状態を保持できるようにする仕組みが「セッション」です。

例えばログイン制の Web サイトなどでは、一度ログインしたらしばらくの間はいくらページ遷移（リクエスト）してもログイン状態が保持されますよね。これはセッションに「ログイン済み」という情報が保存されているためです。

> 状態を保持する代表的な技術としては、もう一つ [Cookie（クッキー）](http://ja.wikipedia.org/wiki/HTTP_cookie) というものがありますが、ここでは説明は割愛します。各自 [適当にググって](https://www.google.co.jp/search?q=session%E3%81%A8cookie&oq=session%E3%81%A8cookie&aqs=chrome..69i57.2252j0j4&sourceid=chrome&es_sm=119&ie=UTF-8) 勉強してみてください。（セッションや Cookie についての理解は、ある程度複雑な Web アプリケーションを作っていく上で避けては通れない道なので、ぜひ積極的に学んでおいてください。）

### 実践編

それでは、実際に簡易電卓プログラムに CSRF 対策を施しましょう。
上述した 1 〜 4 の流れをプログラムのコードに落とし込んでいければ OK です。

とは言え、具体的に何をどうすればいいか分からないかと思いますので、いくつかヒントを挙げておきます。
ぜひ頑張ってチャレンジしてみてください！

#### ヒント

* PHP でセッションを使用するには、プログラムの冒頭で `session_start()` をコールすればよいです
* ワンタイムトークンは `$token = sha1(uniqid(mt_rand(), true));` というコードで生成すると安全で推測されにくいものが作れます
* セッションに値を保存するには、`$_SESSION['自由なキー'] = '値';` とすればよいです
* 同様に、セッションに保存されている値を取り出すには、`$value = $_SESSION['保存時に指定したキー'];` とします

**参考リンク：**
[session_start()](http://php.net/manual/ja/function.session-start.php),
[sha1()](http://php.net/manual/ja/function.sha1.php),
[uniqid()](http://php.net/manual/ja/function.uniqid.php),
[mt_rand()](http://php.net/manual/ja/function.mt-rand.php),
[$_SESSION](http://php.net/manual/ja/reserved.variables.session.php)

#### 解答例

解答例は [こちら](calc-security-impl-02.md) です。自力でチャレンジしてから見てください。

対策を行ったら、再度 [こちら](http://php-abc-quests.herokuapp.com/03-index.php/csrf-demo/) にアクセスしてみてください。今度はメールが送信されないはずです :+1:

## 参考リンク

* XSS, CSRF をはじめ PHP での基本的なセキュリティ対策については、初心者向けに書かれた [@Hamachiya2](https://twitter.com/Hamachiya2) さんの記事 [5分でできるPHPセキュリティ対策](http://d.hatena.ne.jp/Hamachiya2/20120215/php_security) が参考になるかもしれません
* 同じく [@Hamachiya2](https://twitter.com/Hamachiya2) さんの連載記事 [はまちちゃんのセキュリティ講座］ここがキミの脆弱なところ…！](http://gihyo.jp/dev/serial/01/hamachiya2) も参考になるかもしれません
